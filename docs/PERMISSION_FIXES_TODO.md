# قائمة إصلاح تفاصيل الصلاحيات في الواجهة

هذا الملف يلخص ما تم تنفيذه وما تبقى لربط كل الأزرار والإجراءات بصلاحيات الموظفين بدقة.

## الصلاحيات المعرّفة (`lib/permissions.ts`)

| المفتاح | الوصف |
|--------|--------|
| `users.view` | عرض المستخدمين |
| `users.create` | إنشاء مستخدم |
| `users.update` | تعديل المستخدمين |
| `users.toggle_status` | تفعيل/إيقاف الحساب |
| `products.view` | عرض المنتجات |
| `products.approve` | الموافقة على المنتجات |
| `products.manage` | إدارة المنتجات (تعديل، قفل، إضافة، حذف) |
| `orders.view` | عرض الطلبات |
| `orders.manage` | إدارة الطلبات (تحديث حالة، حذف، إجراءات جماعية) |
| `withdrawals.view` | عرض طلبات السحب |
| `withdrawals.process` | معالجة السحوبات |
| `categories.manage` | إدارة الفئات |
| `earnings.view` | عرض الأرباح |
| `earnings.export` | تصدير الأرباح |
| `settings.manage` | إعدادات النظام |
| `messages.moderate` | الموافقة على الرسائل |
| `analytics.view` | التحليلات |
| `product_stats.view` | إحصائيات المنتج |

---

## تم تنفيذه

### المنتجات
- [x] **صفحة المنتجات** (`/dashboard/products`): زر "إضافة منتج جديد" يظهر فقط لـ المورد أو للإدارة ذات صلاحية `products.manage`.
- [x] أزرار تعديل / حذف / قفل / إحصائيات في القائمة والبطاقات مرتبطة بـ `products.manage` و `product_stats.view`.
- [x] أزرار اعتماد / رفض / إعادة تقديم مرتبطة بـ `products.approve`.
- [x] **مكوّن AdminProductsTableView**: دعم `showEditLink` و `showStatsLink` وتمرير معالجات الاعتماد فقط عند وجود الصلاحية.
- [x] **صفحة إضافة منتج** (`/dashboard/products/new`): حراسة الدخول — الإدارة تحتاج `products.manage`.
- [x] **لوحة التحكم**: رابط "إضافة منتج جديد" في قسم "أفضل المنتجات" يظهر فقط مع `products.manage`.

### الطلبات
- [x] **صفحة الطلبات** (`/dashboard/orders`): عمود الاختيار (checkbox) والإجراءات الجماعية تظهر فقط مع `orders.manage`.
- [x] زر حذف الطلب (سطح المكتب والجوال) يظهر فقط مع `orders.manage`.
- [x] زر تصدير الطلبات للإدارة يظهر مع `orders.view`.

### المستخدمون
- [x] **صفحة المستخدمين** (`/dashboard/users`): زر "إضافة مستخدم جديد" يظهر فقط مع `users.create`.
- [x] روابط/أزرار "تعديل" تظهر فقط مع `users.update`.
- [x] أزرار تفعيل/إيقاف الحساب تظهر فقط مع `users.toggle_status`.

### القائمة الجانبية
- [x] عناصر القائمة للأدمن تُصفّى مسبقاً حسب `canAccessPath` (الصلاحية المرتبطة بكل مسار).

### الهيدر
- [x] **شريط البحث** (البحث عن المنتجات): يظهر للمسوق/تاجر الجملة/المورد دائماً؛ للإدارة فقط مع صلاحية `products.view`.
- [x] **أيقونة المحادثة**: تظهر للمسوق والإدارة فقط (وفقاً لتحميل ويدجت المحادثة في الـ layout).

### صفحة منتج واحد وتحرير منتج
- [x] **عرض المنتج** (`/dashboard/products/[id]`): إخفاء أزرار التعديل / الاعتماد / الإحصائيات / القفل حسب صلاحيات `products.manage`، `products.approve`، `product_stats.view`.
- [x] **تعديل المنتج** (`/dashboard/products/[id]/edit`): حراسة الدخول — الإدارة تحتاج `products.manage`.

### السحوبات / الفئات / الأرباح / الإعدادات / الرسائل
- [x] **طلبات السحب** (`/dashboard/admin/withdrawals`): جلب البيانات وفقاً لـ `withdrawals.view`؛ أزرار الموافقة/الرفض/إكمال التحويل تظهر فقط مع `withdrawals.process`.
- [x] **الفئات** (`/dashboard/admin/categories`): حراسة الدخول وجلب البيانات وفقاً لـ `categories.manage`.
- [x] **تقرير الأرباح** (`/dashboard/admin/earnings`): جلب البيانات وفقاً لـ `earnings.view`؛ زر التصدير يظهر فقط مع `earnings.export`.
- [ ] **إعدادات النظام** (`/dashboard/admin/settings`): الصفحة نفسها محمية بـ `settings.manage` في الـ API والـ sidebar.
- [ ] **الرسائل** (`/dashboard/messages` أو `/dashboard/admin/messages`): إخفاء أزرار "الموافقة على الرسائل" عن من لا يملك `messages.moderate`.

### صفحة تفاصيل الطلب
- [x] **تفاصيل الطلب** (`/dashboard/orders/[id]`): أزرار حذف الطلب، تعديل الشحن، وإجراءات الإدارة تظهر فقط مع `orders.manage`.

### حراسة المسارات (Route guard)
- [ ] التأكد من أن كل صفحة إدارية تتحقق من الصلاحية المناسبة عند التحميل (إما عبر `canAccessPath` في الـ layout أو تحقق صريح في الصفحة) وإعادة توجيه من لا يملك الصلاحية.

---

## ملاحظات

- **الموردون**: لا يخضعون لنظام صلاحيات الموظفين؛ يبقى لهم إضافة وتعديل منتجاتهم دائماً.
- **القائمة الجانبية**: تستخدم `canAccessPath(user, href)` فلا يظهر رابط الصفحة أصلاً إن لم تكن الصلاحية ممنوحة؛ إخفاء الأزرار داخل الصفحة يمنع تنفيذ إجراءات غير مسموحة عند الوصول من رابط آخر أو مشاركة الرابط.
