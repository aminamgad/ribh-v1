# إصلاح: "رابط المنتج محجوز" والتكامل يصبح غير نشط

## المشكلة
- عند تصدير منتج إلى Easy Orders تظهر رسالة **"رابط المنتج محجوز"** (Product link reserved).
- بعد الخطأ يصبح **التكامل في حالة خطأ** ويُعامل في الواجهة كأنه غير نشط (لا يمكن استخدام أزرار المزامنة/الويب هوك وغيرها).

## الأسباب
1. **رابط المنتج محجوز**: واجهة Easy Orders تتطلب أن يكون حقل `slug` (رابط المنتج) **فريداً** ضمن المتجر. كان يتم توليد الـ slug من اسم المنتج فقط، فإذا تشابه اسم منتجين أو كان الرابط مستخدماً سابقاً يرفض الـ API الطلب.
2. **التكامل يصبح غير نشط**: عند أي فشل في التصدير كان يتم استدعاء `integration.updateStatus(IntegrationStatus.ERROR, ...)` فيضع التكامل في حالة `error` حتى عند أخطاء من نوع "عميل" (مثل 400 - رابط محجوز)، فيتوقف المستخدم عن استخدام التكامل.

## الإصلاحات المطبقة

### 1. جعل slug المنتج فريداً دائماً
- **الملف:** `lib/integrations/easy-orders/product-converter.ts`
- **التعديل:** بدلاً من استخدام `generateSlug(product.name)` فقط، يتم إلحاق **معرف المنتج** (آخر 8 أحرف من `product._id`) لضمان عدم تكرار الرابط:
  - `slug = baseSlug + '-' + uniqueSuffix` أو `product-{suffix}` إذا كان الاسم لا ينتج slug صالحاً.
- **النتيجة:** كل منتج يحصل على رابط فريد ولا يحدث تعارض "رابط المنتج محجوز" بسبب التكرار.

### 2. عدم وضع التكامل في حالة ERROR عند أخطاء العميل (400)
- **الملف:** `app/api/integrations/easy-orders/export-product/route.ts`
- **التعديل:** عند فشل التصدير:
  - إذا كان رمز الاستجابة **4xx** (مثل 400 رابط محجوز، 404، إلخ) **لا** يتم استدعاء `updateStatus(IntegrationStatus.ERROR, ...)`.
  - يتم استدعاء `updateStatus(ERROR)` فقط عند أخطاء مثل **401/403** (صلاحيات) أو **5xx** (خطأ من الخادم).
  - إرجاع رمز HTTP المناسب للمستخدم (مثلاً 400 عند رابط محجوز).
- **النتيجة:** رسالة "رابط المنتج محجوز" تظهر للمستخدم لكن **التكامل يبقى نشطاً** ويمكنه إعادة المحاولة أو تصدير منتجات أخرى.

## قائمة التحقق (Todo)
- [x] جعل slug فريداً بإلحاق معرف المنتج
- [x] عدم تحديث حالة التكامل إلى ERROR عند 4xx (رابط محجوز)
- [x] توثيق الإصلاح

## ملاحظات
- التصدير الجماعي (`export-bulk`) يضع التكامل في حالة ERROR فقط عندما **تفشل كل** المنتجات؛ إن فشل بعضها فقط يبقى التكامل ACTIVE.
- إن استمر ظهور "رابط المنتج محجوز" بعد هذا الإصلاح (مثلاً منتج مُصدَّر سابقاً برابط قديم)، يمكن لاحقاً إضافة إعادة محاولة تلقائية بسلوق يحتوي على لاحقة عشوائية أو timestamp.
