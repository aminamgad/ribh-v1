# قائمة مهام: عرض المنتجات بشكل ذكي (تحميل المزيد / infinite scroll)

## الوضع الحالي
- الـ API يرجع صفحة واحدة فقط: `page` و `limit` (افتراضي 20).
- الواجهة تعرض 20 منتج ثم أزرار "السابق / التالي" للتنقل بين الصفحات.
- المستخدم يريد رؤية المنتجات بشكل ذكي: تحميل أول دفعة ثم **تحميل المزيد عند التمرير** أو زر **"تحميل المزيد"** بدلاً من الاكتفاء بـ 20 منتج.

---

## الهدف
عرض المنتجات بشكل تدريجي:
1. **التحميل الأول:** عرض أول 20 (أو 24) منتج.
2. **تحميل المزيد:** عند الوصول لأسفل القائمة (infinite scroll) أو عند الضغط على "تحميل المزيد"، جلب الصفحة التالية وإضافتها للقائمة دون استبدالها.
3. **الإيقاف:** عندما يتم تحميل كل الصفحات (لا توجد صفحة تالية)، إخفاء زر "تحميل المزيد" أو عدم طلب المزيد.

---

## Todo List

### 1. دعم الـ API للصفحات (التحقق / التوثيق)
- [ ] **1.1** التأكد أن `GET /api/products` يدعم `page` و `limit` ويرجع `pagination: { page, limit, total, pages }` (موجود حالياً).
- [ ] **1.2** (اختياري) إضافة حد أقصى لـ `limit` في الـ API (مثلاً 50 أو 100) لتجنب طلبات ثقيلة.

### 2. فصل مفتاح الكاش عن رقم الصفحة
- [ ] **2.1** جعل مفتاح الكاش يعتمد على **الفلاتر فقط** (بحث، فئة، سعر، حالة، مورد، إلخ) **بدون** `page`، حتى الطلب الأول يُخزَّن تحت مفتاح ثابت.
- [ ] **2.2** إدارة "الصفحات المحملة" و"قائمة المنتجات المتراكمة" في state منفصل عن الكاش: مثلاً `accumulatedProducts: Product[]` و `loadedPage: number` و `hasMore: boolean`.
- [ ] **2.3** عند تغيير الفلاتر (queryString يتغير): إعادة تعيين `accumulatedProducts` و `loadedPage` وطلب الصفحة 1 من جديد.

### 3. منطق "تحميل المزيد" في الصفحة
- [ ] **3.1** الطلب الأول: استدعاء الـ API بـ `page=1&limit=20` (أو 24)، تعبئة `accumulatedProducts` و `pagination` و `hasMore = (page < pages)`.
- [ ] **3.2** تحميل المزيد: استدعاء الـ API بـ نفس الفلاتر و `page=loadedPage+1&limit=20`، عند النجاح إلحاق `response.products` بـ `accumulatedProducts` وتحديث `loadedPage` و `hasMore`.
- [ ] **3.3** عدم وضع طلبات "الصفحة N" في useDataCache بنفس المفتاح (لأن الكاش يعيد نفس البيانات للصفحة 1). إما:
  - استخدام **استدعاء fetch مباشر** لصفحات 2, 3, ... وإلحاق النتائج بالـ state، أو
  - استخدام مفتاح كاش يتضمن رقم الصفحة **لصفحات التحمل الإضافي فقط** ودمج النتائج في state محلي.

### 4. واجهة المستخدم لـ "تحميل المزيد"
- [ ] **4.1** إضافة زر **"تحميل المزيد"** أسفل قائمة المنتجات (جدول أو شبكة)، يظهر فقط عندما `hasMore === true`.
- [ ] **4.2** عند الضغط: تعيين `loadingMore = true`، طلب الصفحة التالية، عند الانتهاء إلحاق المنتجات وإيقاف `loadingMore`.
- [ ] **4.3** (بديل أو إضافي) **Infinite scroll:** استخدام Intersection Observer لرصد وصول المستخدم لقرب نهاية القائمة، ثم استدعاء نفس منطق "تحميل المزيد" تلقائياً دون زر.
- [ ] **4.4** عرض مؤشر تحميل أثناء جلب الصفحة التالية (سبنر أو هيكل skeleton صغير) دون إخفاء القائمة الحالية.

### 5. التوافق مع الترتيب والملخص
- [ ] **5.1** الترتيب (اسم، سعر، مخزون، تاريخ) يبقى **على المنتجات المعروضة فقط** (الـ accumulated list) لأن الـ API يرجع صفحات مرتبة مسبقاً؛ إذا كان الترتيب من الواجهة فقط، تطبيقه على `accumulatedProducts` بعد كل إلحاق.
- [ ] **5.2** شريط الملخص (إجمالي، متوفر، غير متوفر): استخدام `pagination.total` للإجمالي عند وجوده، وعدد `accumulatedProducts.length` كبديل حتى اكتمال التحميل، أو إظهار "عرض X من Y" عند التحميل التدريجي.

### 6. إزالة أو إخفاء ترقيم الصفحات الكلاسيكي
- [ ] **6.1** إزالة أزرار "السابق / التالي" و "صفحة X من Y" من واجهة قائمة المنتجات عند تفعيل "تحميل المزيد"، أو جعلها اختيارية (مثلاً للأدمن فقط) حسب التصميم المطلوب.
- [ ] **6.2** إذا بقي ترقيم الصفحات في مكان آخر (مثلاً تقارير)، التأكد أنه لا يعتمد على نفس الـ state المستخدم في صفحة المنتجات.

### 7. تجربة الجوال والأداء
- [ ] **7.1** على الجوال: التأكد أن زر "تحميل المزيد" بارتفاع لمس كافٍ (مثلاً 44px) وأن التحميل لا يسبب قفزاً مزعجاً.
- [ ] **7.2** إذا تم استخدام infinite scroll: تفعيله فقط بعد تحميل أول صفحة، وتجنب طلبات متعددة متزامنة (قفل حتى انتهاء الطلب الحالي).

### 8. الاختبار والتحقق
- [ ] **8.1** التحقق مع فلاتر (فئة، سعر، بحث): تغيير الفلتر يعيد القائمة من الصفحة 1 ويُعيد تعيين "تحميل المزيد".
- [ ] **8.2** التحقق مع أدوار مختلفة (أدمن، مسوق، مورد، تاجر جملة): نفس السلوك حيثما تظهر قائمة المنتجات.
- [ ] **8.3** تشغيل `npm run build` والتأكد من عدم وجود أخطاء.

---

## ملخص التنفيذ المقترح

| الخطوة | الملف/المكان | الإجراء |
|--------|--------------|---------|
| 2 | `app/dashboard/products/page.tsx` | state: `accumulatedProducts`, `loadedPage`, `hasMore`, `loadingMore`؛ مفتاح الكاش بدون `page`. |
| 3 | نفس الصفحة | دالة `loadMore()` تستدعي API بـ `page=loadedPage+1` وتلحق النتائج. |
| 4 | نفس الصفحة + ربما مكوّن فرعي | زر "تحميل المزيد" و/أو Intersection Observer لـ infinite scroll. |
| 5–6 | نفس الصفحة | استخدام `accumulatedProducts` للعرض والترتيب؛ إزالة أو تعديل أزرار الترقيم. |
| 1, 7, 8 | API + الصفحة | مراجعة واختبار. |

بعد إكمال هذه النقاط ستظهر المنتجات بشكل ذكي: أول دفعة ثم تحميل المزيد عند الطلب أو عند التمرير، مع الحفاظ على الفلاتر والترتيب والملخص.
