# إشعار اكتمال إعادة حساب أسعار المنتجات

## الهدف
إشعار مدير النظام عند **انتهاء** عملية إعادة حساب أسعار المنتجات (وليس عند البدء فقط)، مع أن يعمل الإشعار حتى لو غادر الصفحة أو كان في صفحة أخرى، وأن يعمل بشكل سليم عند حفظ الإعدادات لأول مرة.

---

## Todo List

### 1. تخزين حالة إعادة الحساب في الخادم
- [x] **1.1** إضافة حقل `recalculationStatus` في نموذج `SystemSettings`: `status` (idle | running | completed | failed)، `startedAt`، `completedAt`، `result` (updated, skipped, errors).
- [x] **1.2** عند حفظ الإعدادات المالية: تعيين الحالة إلى `running` قبل تشغيل إعادة الحساب في الخلفية.
- [x] **1.3** عند انتهاء إعادة الحساب بنجاح: تحديث الحالة إلى `completed` مع `completedAt` و`result`.
- [x] **1.4** عند فشل إعادة الحساب: تحديث الحالة إلى `failed`.

### 2. واجهة API للاستعلام عن الحالة
- [x] **2.1** إنشاء `GET /api/admin/recalculation-status` يُرجع الحالة الحالية (للمدير فقط).
- [x] **2.2** استخدام نفس الحماية: `withRole(['admin'])` و`adminRateLimit`.

### 3. مزود الإشعار في الواجهة (يعمل عند التنقل)
- [x] **3.1** إنشاء `RecalculationNotificationProvider` يعرض `startWatchingRecalculation()`.
- [x] **3.2** عند استدعاء `startWatchingRecalculation()`: بدء استطلاع دوري لـ `GET /api/admin/recalculation-status` (مثلاً كل 2.5 ثانية).
- [x] **3.3** عند الحصول على `status === 'completed'`: إظهار toast نجاح ثم إيقاف الاستطلاع.
- [x] **3.4** عند `status === 'failed'`: إظهار toast خطأ ثم إيقاف الاستطلاع.
- [x] **3.5** مهلة انتظار (مثلاً 10 دقائق): إن انتهت دون اكتمال، إيقاف الاستطلاع وإظهار رسالة مناسبة.
- [x] **3.6** وضع المزود داخل `dashboard/layout` حتى يبقى نشطاً عند التنقل بين صفحات لوحة التحكم — الإشعار يصل حتى لو كان المستخدم في صفحة أخرى.

### 4. ربط صفحة الإعدادات
- [x] **4.1** في صفحة إعدادات المدير: عند نجاح حفظ الإعدادات المالية استدعاء `startWatchingRecalculation()`.
- [x] **4.2** التأكد أن نفس المسار يُستخدم عند **أول حفظ** (إنشاء إعدادات جديدة) وعند التعديل — أي أن تشغيل إعادة الحساب وتحديث الحالة يعملان في الحالتين.

### 5. التحقق
- [ ] **5.1** حفظ الإعدادات المالية من صفحة الإعدادات والانتظار: يظهر إشعار البدء ثم إشعار الاكتمال.
- [ ] **5.2** حفظ الإعدادات ثم الانتقال فوراً لصفحة أخرى (مثلاً المنتجات): يصل إشعار الاكتمال في الصفحة الحالية.
- [ ] **5.3** حفظ الإعدادات المالية لأول مرة (عند عدم وجود إعدادات سابقة): يعمل الإشعار بنفس الطريقة.

---

## ملخص التنفيذ

| الملف | التعديل |
|-------|---------|
| `models/SystemSettings.ts` | إضافة `recalculationStatus` (واجهة + schema). |
| `app/api/admin/settings/route.ts` | تعيين `running` قبل التشغيل، وتحديث `completed`/`failed` بعد الانتهاء. |
| `app/api/admin/recalculation-status/route.ts` | **جديد** — GET يُرجع الحالة. |
| `components/providers/RecalculationNotificationProvider.tsx` | **جديد** — استطلاع + toast عند الاكتمال. |
| `app/dashboard/layout.tsx` | لف المحتوى بـ `RecalculationNotificationProvider`. |
| `app/dashboard/admin/settings/page.tsx` | استدعاء `startWatchingRecalculation()` عند نجاح حفظ القسم المالي. |
